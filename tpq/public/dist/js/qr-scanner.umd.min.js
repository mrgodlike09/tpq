"use strict";!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).QrScanner=t()}(this,function(){class e{static hasCamera(){return navigator.mediaDevices?navigator.mediaDevices.enumerateDevices().then(e=>e.some(e=>"videoinput"===e.kind)).catch(()=>!1):Promise.resolve(!1)}constructor(t,i,a=this._onDecodeError,s=this._calculateScanRegion,n="environment"){this.$video=t,this.$canvas=document.createElement("canvas"),this._onDecode=i,this._legacyCanvasSize=e.DEFAULT_CANVAS_SIZE,this._preferredFacingMode=n,this._flashOn=this._paused=this._active=!1,"number"==typeof a?(this._legacyCanvasSize=a,console.warn("You're using a deprecated version of the QrScanner constructor which will be removed in the future")):this._onDecodeError=a,"number"==typeof s?(this._legacyCanvasSize=s,console.warn("You're using a deprecated version of the QrScanner constructor which will be removed in the future")):this._calculateScanRegion=s,this._scanRegion=this._calculateScanRegion(t),this._onPlay=this._onPlay.bind(this),this._onLoadedMetaData=this._onLoadedMetaData.bind(this),this._onVisibilityChange=this._onVisibilityChange.bind(this),this.$video.playsInline=!0,this.$video.muted=!0,this.$video.disablePictureInPicture=!0,this.$video.addEventListener("play",this._onPlay),this.$video.addEventListener("loadedmetadata",this._onLoadedMetaData),document.addEventListener("visibilitychange",this._onVisibilityChange),this._qrEnginePromise=e.createQrEngine()}hasFlash(){if(!("ImageCapture"in window))return Promise.resolve(!1);let e=this.$video.srcObject?this.$video.srcObject.getVideoTracks()[0]:null;return e?new ImageCapture(e).getPhotoCapabilities().then(e=>e.fillLightMode.includes("flash")).catch(e=>(console.warn(e),!1)):Promise.reject("Camera not started or not available")}isFlashOn(){return this._flashOn}toggleFlash(){return this._setFlash(!this._flashOn)}turnFlashOff(){return this._setFlash(!1)}turnFlashOn(){return this._setFlash(!0)}destroy(){this.$video.removeEventListener("loadedmetadata",this._onLoadedMetaData),this.$video.removeEventListener("play",this._onPlay),document.removeEventListener("visibilitychange",this._onVisibilityChange),this.stop(),e._postWorkerMessage(this._qrEnginePromise,"close")}start(){if(this._active&&!this._paused)return Promise.resolve();if("http:"!==window.location.protocol&&console.warn("The camera stream is only accessible if the page is transferred via https."),this._active=!0,this._paused=!1,document.hidden)return Promise.resolve();if(clearTimeout(this._offTimeout),this._offTimeout=null,this.$video.srcObject)return this.$video.play(),Promise.resolve();let e=this._preferredFacingMode;return this._getCameraStream(e,!0).catch(()=>(e="environment"===e?"user":"environment",this._getCameraStream())).then(t=>{e=this._getFacingMode(t)||e,this.$video.srcObject=t,this.$video.play(),this._setVideoMirror(e)}).catch(e=>{throw this._active=!1,e})}stop(){this.pause(),this._active=!1}pause(){this._paused=!0,this._active&&(this.$video.pause(),this._offTimeout||(this._offTimeout=setTimeout(()=>{let e=this.$video.srcObject?this.$video.srcObject.getTracks():[];for(let t of e)t.stop();this._offTimeout=this.$video.srcObject=null},300)))}static scanImage(t,i=null,a=null,s=null,n=!1,r=!1){let o=a instanceof Worker,h=Promise.all([a||e.createQrEngine(),e._loadImage(t)]).then(([t,r])=>{let h;return a=t,[s,h]=this._drawToCanvas(r,i,s,n),a instanceof Worker?(o||a.postMessage({type:"inversionMode",data:"both"}),new Promise((t,i)=>{let n,r,o;r=(s=>{"qrResult"===s.data.type&&(a.removeEventListener("message",r),a.removeEventListener("error",o),clearTimeout(n),null!==s.data.data?t(s.data.data):i(e.NO_QR_CODE_FOUND))}),o=(e=>{a.removeEventListener("message",r),a.removeEventListener("error",o),clearTimeout(n),i("Scanner error: "+(e?e.message||e:"Unknown Error"))}),a.addEventListener("message",r),a.addEventListener("error",o),n=setTimeout(()=>o("timeout"),1e4);let c=h.getImageData(0,0,s.width,s.height);a.postMessage({type:"decode",data:c},[c.data.buffer])})):new Promise((t,i)=>{let n=setTimeout(()=>i("Scanner error: timeout"),1e4);a.detect(s).then(a=>{a.length?t(a[0].rawValue):i(e.NO_QR_CODE_FOUND)}).catch(e=>i("Scanner error: "+(e.message||e))).finally(()=>clearTimeout(n))})});return i&&r&&(h=h.catch(()=>e.scanImage(t,null,a,s,n))),h.finally(()=>{o||e._postWorkerMessage(a,"close")})}setGrayscaleWeights(t,i,a,s=!0){e._postWorkerMessage(this._qrEnginePromise,"grayscaleWeights",{red:t,green:i,blue:a,useIntegerApproximation:s})}setInversionMode(t){e._postWorkerMessage(this._qrEnginePromise,"inversionMode",t)}static createQrEngine(t=e.WORKER_PATH){return("BarcodeDetector"in window?BarcodeDetector.getSupportedFormats():Promise.resolve([])).then(e=>-1!==e.indexOf("qr_code")?new BarcodeDetector({formats:["qr_code"]}):new Worker(t))}_onPlay(){this._scanRegion=this._calculateScanRegion(this.$video),this._scanFrame()}_onLoadedMetaData(){this._scanRegion=this._calculateScanRegion(this.$video)}_onVisibilityChange(){document.hidden?this.pause():this._active&&this.start()}_calculateScanRegion(e){let t=Math.round(2/3*Math.min(e.videoWidth,e.videoHeight));return{x:(e.videoWidth-t)/2,y:(e.videoHeight-t)/2,width:t,height:t,downScaledWidth:this._legacyCanvasSize,downScaledHeight:this._legacyCanvasSize}}_scanFrame(){if(!this._active||this.$video.paused||this.$video.ended)return!1;requestAnimationFrame(()=>{1>=this.$video.readyState?this._scanFrame():this._qrEnginePromise.then(t=>e.scanImage(this.$video,this._scanRegion,t,this.$canvas)).then(this._onDecode,t=>{this._active&&(-1!==(t.message||t).indexOf("service unavailable")&&(this._qrEnginePromise=e.createQrEngine()),this._onDecodeError(t))}).then(()=>this._scanFrame())})}_onDecodeError(t){t!==e.NO_QR_CODE_FOUND&&console.log(t)}_getCameraStream(e,t=!1){let i=[{width:{min:1024}},{width:{min:768}},{}];return e&&(t&&(e={exact:e}),i.forEach(t=>t.facingMode=e)),this._getMatchingCameraStream(i)}_getMatchingCameraStream(e){return navigator.mediaDevices&&0!==e.length?navigator.mediaDevices.getUserMedia({video:e.shift()}).catch(()=>this._getMatchingCameraStream(e)):Promise.reject("Camera not found.")}_setFlash(e){return this.hasFlash().then(t=>t?this.$video.srcObject.getVideoTracks()[0].applyConstraints({advanced:[{torch:e}]}):Promise.reject("No flash available")).then(()=>this._flashOn=e)}_setVideoMirror(e){this.$video.style.transform="scaleX("+("user"===e?-1:1)+")"}_getFacingMode(e){return(e=e.getVideoTracks()[0])?/rear|back|environment/i.test(e.label)?"environment":/front|user|face/i.test(e.label)?"user":null:null}static _drawToCanvas(e,t=null,i=null,a=!1){i=i||document.createElement("canvas");let s=t&&t.x?t.x:0,n=t&&t.y?t.y:0,r=t&&t.width?t.width:e.width||e.videoWidth,o=t&&t.height?t.height:e.height||e.videoHeight;return a||(i.width=t&&t.downScaledWidth?t.downScaledWidth:r,i.height=t&&t.downScaledHeight?t.downScaledHeight:o),(t=i.getContext("2d",{alpha:!1})).imageSmoothingEnabled=!1,t.drawImage(e,s,n,r,o,0,0,i.width,i.height),[i,t]}static _loadImage(t){if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement||window.ImageBitmap&&t instanceof window.ImageBitmap||window.OffscreenCanvas&&t instanceof window.OffscreenCanvas)return Promise.resolve(t);if(t instanceof Image)return e._awaitImageLoad(t).then(()=>t);if(t instanceof File||t instanceof Blob||t instanceof URL||"string"==typeof t){let i=new Image;return i.src=t instanceof File||t instanceof Blob?URL.createObjectURL(t):t,e._awaitImageLoad(i).then(()=>((t instanceof File||t instanceof Blob)&&URL.revokeObjectURL(i.src),i))}return Promise.reject("Unsupported image type.")}static _awaitImageLoad(e){return new Promise((t,i)=>{if(e.complete&&0!==e.naturalWidth)t();else{let a,s;a=(()=>{e.removeEventListener("load",a),e.removeEventListener("error",s),t()}),s=(()=>{e.removeEventListener("load",a),e.removeEventListener("error",s),i("Image load error")}),e.addEventListener("load",a),e.addEventListener("error",s)}})}static _postWorkerMessage(e,t,i){return Promise.resolve(e).then(e=>{e instanceof Worker&&e.postMessage({type:t,data:i})})}}return e.DEFAULT_CANVAS_SIZE=400,e.NO_QR_CODE_FOUND="No QR code found",e.WORKER_PATH="/dist/js/qr-scanner-worker.min.js",e});
//# sourceMappingURL=qr-scanner.umd.min.js.map